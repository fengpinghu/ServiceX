<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Specifying a request - ServiceX</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Specifying a request";
    var mkdocs_page_input_path = "requests.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> ServiceX</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../introduction/">Introduction</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../installation/">Getting started</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Specifying a request</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#selecting-endpoints">Selecting endpoints</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#creating-a-request-via-func_adl">Creating a request via func_adl</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#using-helper-functions-to-construct-a-query">Using helper functions to construct a query</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#choosing-the-output">Choosing the output</a>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../outreach/">Outreach</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../development/">Development</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">ServiceX</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Specifying a request</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="using-servicex">Using ServiceX</h1>
<p>A transformation request is a specifically formatted request sent to ServiceX. It includes
information on what input dataset is to be used, what preselection is to be applied (including
computation of new columns, if any), and what columns should be returned to the user.</p>
<h2 id="selecting-endpoints">Selecting endpoints</h2>
<p>Each request requires two endpoints, one corresponding to the service itself, and one for the
output of the request. The current available endpoints are shown below.</p>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>Type</th>
<th>Location</th>
<th>Experiment</th>
<th>Input</th>
</tr>
</thead>
<tbody>
<tr>
<td>rc1-xaod-servicex.uc.ssl-hep.org</td>
<td>ServiceX</td>
<td>SSL-RIVER</td>
<td>ATLAS</td>
<td>xAOD files</td>
</tr>
<tr>
<td>rc1-xaod-minio.uc.ssl-hep.org</td>
<td>MinIO</td>
<td>SSL-RIVER</td>
<td>ATLAS</td>
<td>xAOD files</td>
</tr>
<tr>
<td>rc1-uproot-servicex.uc.ssl-hep.org</td>
<td>ServiceX</td>
<td>SSL-RIVER</td>
<td>ATLAS</td>
<td>Flat ntuples</td>
</tr>
<tr>
<td>rc1-uproot-minio.uc.ssl-hep.org</td>
<td>MinIO</td>
<td>SSL-RIVER</td>
<td>ATLAS</td>
<td>Flat ntuples</td>
</tr>
</tbody>
</table>
<h2 id="creating-a-request-via-func_adl">Creating a request via func_adl</h2>
<p>In order to use <code>func_adl</code> directly we start with a <a href="https://github.com/iris-hep/qastle">Qastle</a>
query as our input. The following is a query designed to extract the transverse momenta of a jet
collection in some xAOD-formatted dataset:</p>
<pre><code>my_query = "(call ResultTTree" \
    "(call Select" \
        "(call SelectMany" \
            "(call EventDataset (list 'localds:bogus'))" \
            "(lambda (list e) (call (attr e 'Jets') 'AntiKt4EMTopoJets'))" \
        ") (lambda (list j) (/ (call (attr j 'pt')) 1000.0))" \
    ") (list 'JetPt') 'analysis' 'junk.root')"
</code></pre>
<p>Given this input, we can produce output containing the transverse momenta of all jets in an ATLAS
xAOD file. We start by specifying the structure of the ServiceX request:</p>
<pre><code>import servicex
dataset = ‘mc15_13TeV:mc15_13TeV.361106.PowhegPythia8EvtGen_AZNLOCTEQ6L1_Zee.merge.DAOD_STDM3.e3601_s2576_s2132_r6630_r6264_p2363_tid05630052_00’
sx_endpoint = 'http://rc1-xaod-servicex.uc.ssl-hep.org'
minio_endpoint = 'rc1-xaod-minio.uc.ssl-hep.org'
ds = servicex.ServiceXDataset(
    dataset,
    servicex.ServiceXAdaptor(sx_endpoint, username='mweinberg', password='XXXXXXXXX'),
    servicex.MinioAdaptor(minio_endpoint)
    )
</code></pre>
<p>Once we have this, we can call ServiceX to output the results of our query in a convenient format:</p>
<pre><code>r = servicex.get_data_pandas_df(my_query)
print(r)
</code></pre>
<p>After about 1--2 minutes, this prints a data frame with a single column for the transverse momenta.</p>
<p>A badly formatted query, or a problem with the file in the backend, will cause an exception to be
thrown. Note that there are also tools like the one
<a href="https://github.com/mweinberg2718/useful-scripts/blob/master/xaod_qastle.py">here</a> that are capable
of turning a text file of requested columns (e.g.
<a href="https://github.com/mweinberg2718/useful-scripts/blob/master/xaod_branches.txt">here</a>) into a
complete Qastle query.</p>
<h2 id="using-helper-functions-to-construct-a-query">Using helper functions to construct a query</h2>
<p>For all but the simplest single-column requests, creating a Qastle query as input can be quite
cumbersome. <code>func_adl</code> provides additional libraries to construct queries. For example, we can
perform the same request using the <code>func_adl_xAOD</code> library:</p>
<pre><code>import func_adl_xAOD
f_ds = func_adl_xAOD.ServiceXDatasetSource(ds)
r = f_ds \
    .SelectMany('lambda e: e.Jets("AntiKt4EMTopoJets")') \
    .Select('lambda j: j.pt() / 1000.0') \
    .AsPandasDF('JetPt') \
    .value()
print(r)
</code></pre>
<p>Note that the <code>Select()</code> function transforms the input dataset by allowing you to select only
objects matching the selection criteria (in this case only the pT attribute of the jet collection).
Meanwhile the function <code>SelectMany()</code> shifts the hierarchy by returning a list of lists (in this
case a list of events, each containing a separate list of jets). <code>AsPandasDF()</code> formats the
output as a Pandas dataframe, and <code>value()</code> is responsible for executing the query.</p>
<p>As a more realistic example, we can construct a request for the four-momenta of the Electron and
Muon collection. In this case let's output the results as a set of AwkwardArrays:</p>
<pre><code>r = f_ds \
    .Select('lambda e: (e.Electrons("Electrons"), e.Muons("Muons"))') \
    .Select('lambda ls: (ls[0].Select(lambda e: e.pt()), \
                         ls[0].Select(lambda e: e.eta()), \
                         ls[0].Select(lambda e: e.phi()), \
                         ls[0].Select(lambda e: e.e()), \
                         ls[1].Select(lambda m: m.pt()), \
                         ls[1].Select(lambda m: m.eta()), \
                         ls[1].Select(lambda m: m.phi()), \
                         ls[1].Select(lambda m: m.e()))') \
    .AsAwkwardArray(('ElePt', 'EleEta', 'ElePhi', 'EleE', 'MuPt', 'MuEta', 'MuPhi', 'MuE')) \
    .value()
</code></pre>
<p>Because the output is an AwkwardArray, which can handle the variable-size set of objects for each
event, it is no longer necessary to use the <code>SelectMany()</code> function as above.</p>
<p>Next, let's consider the case where we wish to return information only for those jets with a pT
passing some threshold cut. This can be done via the <code>Where()</code> function:</p>
<pre><code>r = f_ds \
    .SelectMany('lambda e: e.Jets("AntiKt4EMTopoJets")') \
    .Where('lambda j: j.pt() / 1000.0 &gt; 30.0') \
    .Select('lambda j: j.eta()') \
    .AsPandasDF('JetPt') \
    .value()
</code></pre>
<p>which returns a dataframe with the eta values of all jets whose pT is above 30 GeV.</p>
<h2 id="choosing-the-output">Choosing the output</h2>
<p>There are currently three choices for formatting the output of a ServiceX request: <code>AsPandasDF</code>
returns the output as a Pandas
<a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html">dataframe</a>,
<code>AsROOTTree</code> returns the output as a flat
<a href="https://root.cern.ch/doc/master/classTTree.html">TTree</a>, and <code>AsAwkwardArray</code> returns the output
as an <a href="https://github.com/scikit-hep/awkward-array">Awkward array</a> suitable for use with
<a href="https://github.com/scikit-hep/uproot">uproot</a>.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../outreach/" class="btn btn-neutral float-right" title="Outreach">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../installation/" class="btn btn-neutral" title="Getting started"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../installation/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../outreach/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
